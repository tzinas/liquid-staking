\pdfbookmark[section]{Preliminaries}{Preliminaries}
\section{Preliminaries}\label{sec:preliminaries}

% TODO (tzinas): citations

\noindent
\textbf{Loans.} For the attack we will describe in this paper, some upfront
capital is required. Sometimes a portion of this capital is needed only throughout \emph{one}
transaction. Towards this purpose, a \emph{flash loan}~\cite{gudgeon2020defi} is obtained,
which has zero duration and no funds at risk. We assume that
a loan of duration $\Delta t$ for capital $u$ has an \emph{upfront} cost factor $\beta$,
an \emph{interest rate} $r$ and the amount to be repaid, including both the principal and interest, is
$((1 + r)^{\Delta t} + \beta) u$. The term $\beta$ models the cost factor of a flash loan,
which has duration $0$.
In order to take a loan, a collateral in different currency must be deposited for the duration
of the loan. DeFi protocols typically require overcollateralization. We denote by
$\gamma \geq 1$ the collateral ratio required by the loan provider.
To take a loan of $z$ in one currency, one must deposit the equivalent
value of $\gamma z$ in another currency.

\noindent
\textbf{Proof-of-Stake.} Proof-of-stake systems are secured
by \emph{validators} who propose and vote
on blocks. To become a validator in a slashably safe~\cite{slashable-safety}
system, a stakeholder must \emph{bond} their stake
which locks it up for a particular period of time in return for rewards.
Validators promise they will
not \emph{equivocate} by signing conflicting blocks.
In case of equivocation, a percentage $0 < p \leq 1$ of the locked stake is
\emph{slashed} and the validator is permanently deactivated. In the cryptographic
model, validators can be \emph{honest} or \emph{adversarial}. The honest validators
run the prescribed protocol, and hence never equivocate, whereas the adversarial
validators can deviate from the protocol arbitrarily.

\noindent
\textbf{Delegation.} Since not everyone has the capacity to become a validator,
a stakeholder can \emph{delegate} their stake to a validator to participate in
the validation process in their stead. The voting power of the validator accounts
for the delegated stake, and delegated stake is also slashed in case of validator
misbehavior. The stake bonded by a validator themselves and not delegated from
others is known as \emph{self-delegation}. Self-delegations as
well as stake delegated from others is known as \emph{delegated stake},
and the capital holder of delegated stake is known as the \emph{delegator},
but will also be referred to as the \emph{principal}.
A principal can \emph{undelegate} or \emph{redelegate} at any time,
but must wait\footnote{The waiting period may sometimes be \emph{waived} and redelegations
allowed instantly if no other redelegations have happened within $\delta$, such as
in Cosmos~\cite{cosmos-staking-module}. The important point for us is that, after redelegation has commenced, the
redelegated stake is still prone to slashing due to the \emph{old} validator's misbehavior
for a period of $\delta$.} for an \emph{unbonding period} $\delta$.

\noindent
\textbf{Liquid Staking.} Delegated stake earns rewards, but remains locked and
is illiquid. Principals often wish to rehypothecate their delegated stake as collateral,
for example to take loans~\cite{gudgeon2020defi} or to, more broadly, participate in the
DeFi~\cite{defi-sok} economy. Protocols that enable this ability are known as
\emph{liquid staking protocols}~\cite{liquid-staking-report}.
Some such protocols~\cite{lido,stride} operate
in the form of smart contracts (\eg Lido and Rocket Pool in Ethereum) or separate
appchains\footnote{An appchain is a separate Cosmos zone, connected with other
Cosmos zones using IBC/ICA~\cite{ibc-ica} and functions similar to a smart contract.}
(\eg Stride, pStake, and Quicksilver in Cosmos).
Stakeholders \emph{deposit} their funds into the liquid staking protocol.
Upon deposit, these contracts act as
delegators and delegate the incoming funds to their choice of validators.
They collect this delegated stake into a \emph{pool} and receive staking
rewards from these holdings.
During the deposit, a new derivative asset is minted,
which is given to the depositor as a claim to the delegated stake held by the
liquid staking contract. Such derivative tokens, when issued from the same liquid
staking contract, are fungible with one another\footnote{The exact fungibility
constraints depend on the protocol. For example,
\textsf{stATOM} in Stride~\cite{stride} and \textsf{stETH} in Lido~\cite{lido} are fully fungible.
However, in the proposed Liquidity Staking
Module~\cite{liquidity-staking-module} of Cosmos,
derivative tokens are only fungible when they have been
delegated to the same validator in the same batch.}. We are only concerned with liquid
staking protocols that are fully fungible. At any time, the derivative asset holder
can \emph{redeem} their derivative asset.
During redemption, the contract burns
the holder's derivative assets and returns the respective assets to the holder.
In our treatment, we consider a generic asset that we denominate in \asset
and the respective derivative token, that we denominate in \stasset,
issued by an arbitrary liquid staking protocol.
We assume a perfectly efficient market for \asset and \stasset,
as well as a sufficiently deep loan market with rates
$\rasset$, $\betaasset$, and $\rstasset$, $\betastasset$ respectively.

\noindent
\textbf{Exchange rates.} Initially, \asset and \stasset are priced at a 1:1 exchange rate,
as one can be exchanged for the other by redeeming or withdrawing. However, the balance
of the liquid staking protocol in \asset holdings can change with time due to two reasons.
Firstly, it continuously receives rewards for staking the \asset (these rewards are
auto-compounded). Secondly, if a validator it delegates to misbehaves, a portion of its
\asset can get slashed. These events do not change the supply of \stasset in the market.
The deposit and redemption operations must adjust their price.
Let $b_0$ \asset denote the amount of \asset holdings of the liquid staking
protocol, and $s_0$ \stasset denote the total market supply of \stasset that the protocol
has issued. When the user deposits $b$ \asset, the protocol mints $s = b \frac{s_0}{b_0}$ \stasset.
On the other hand, when the user burns $s$ \asset, the protocol returns $b = s \frac{b_0}{s_0}$
delegated \asset to the user. These delegated \asset can be unbonded to convert them
to \asset. Because the user can always go back to the protocol and exchange $b$ for $s$ or
vice versa, we assume that the price of \stasset denominated in \asset in the
market is the same as the quoted protocol price. We refine this assumption in
Section~\ref{sec:stasset-price}. For completeness, we illustrate the basic deposit and withdrawal
functionalities of any liquid staking protocol in Appendix~\ref{app:contract}.

\noindent
\textbf{Governance.}
The choice of which validator the liquid staking protocol's assets are delegated to
depends on the particularities of the protocol.
In centralized protocols, the decision is taken by a
central party or central committee of parties, who may not be the
liquid stake holders themselves.
Some protocols allow the principals to vote.
During the voting process, anyone can propose for a proportion of the protocols's assets
to be delegated to a validator of their choosing.
Each principal can then vote \emph{yes} or \emph{no}
to the proposal. Decisions are often taken by weighted majority.