\section{Preliminaries}\label{sec:preliminaries}

% TODO: citations

\noindent
\textbf{Loans.} For the attack we will describe in this paper, some upfront
capital is required. A portion of this capital is needed only throughout \emph{one}
transaction. Towards this purpose, a \emph{flash loan}~\cite{gudgeon2020defi} can
be obtained, in which the loan provided does not risk any funds. We assume that
a loan of duration $\Delta t$ for capital $c$ has an \emph{upfront} cost $\beta$
and an \emph{interest rate} $r$ for a total cost of
$((1 + r)^{\Delta t} - 1 + \beta) c$. The term $\beta$ models the cost of a flash loan,
which has duration $0$.

\noindent
\textbf{Proof-of-Stake.} In Proof-of-Stake (PoS) systems, ledgers are secured
by \emph{validators} who participate in the protocol by proposing and voting
on blocks. To become a validator, a stakeholder must \emph{bond} their stake
which locks it up for a particular period of time in return for rewards.
Validators promise they will
not \emph{equivocate} by signing conflicting blocks.
In case of equivocation, a percentage $0 < p \leq 1$ of the locked stake is
\emph{slashed} and the validator is permanently deactivated. In the cryptographic
model, validators can be \emph{honest} or \emph{adversarial}. The honest validators
run the prescribed protocol, and hence never equivocate, whereas the adversarial
validators can deviate from the protocol arbitrarily.

% TODO: accountable/slashable safety

\noindent
\textbf{Delegation.} Since not everyone has the capacity to become a validator,
a stakeholder can \emph{delegate} their stake to a validator to participate in
the validation process in their stead. The voting power of the validator accounts
for the delegated stake, and delegated stake is also slashed in case of validator
misbehavior. The stake bonded by a validator themselves and not delegated from
others is known as \emph{self-delegation}. Self-delegations as
well as stake delegated from others is known as \emph{delegated stake},
and the capital holder of delegated stake is known as the \emph{delegator}.
A delegator can \emph{undelegate} at any time, but must wait for an
\emph{unbonding period} $\delta$.

\noindent
\textbf{Liquid Staking.} Delegated stake earns rewards, but remains locked and
is illiquid. Delegators often wish to use their delegated stake as collateral,
for example to take loans~\cite{gudgeon2020defi} or to, more broadly, participate in the
DeFi~\cite{defi-sok} economy. Protocols that enable this ability are known as
\emph{liquid staking protocols}~\cite{liquid-staking-report}.
Some such protocols~\cite{lido,stride} operate
in the form of smart contracts (\eg Lido in Ethereum) or separate appchains
(\eg Stride, Persistence, and Quicksilver in Cosmos).
Stakeholders \emph{deposit} their funds into the liquid staking protocol.
Upon deposit, these contracts act as
delegators and delegate the incoming funds to their choice of validators.
They collect this delegated stake into a \emph{pool} and receive staking
rewards from these holdings.
During the deposit, a new derivative asset is minted,
which is given to the depositor as a claim to the delegated stake held by the
liquid staking contract. Such derivative tokens, when issued from the same liquid
staking contract, are fungible with one another\footnote{The exact fungibility
constraints depend on the protocol. For example,
\textsf{stATOM} in Stride~\cite{stride} and \textsf{stETH} in Lido~\cite{lido} are fully fungible.
However, in the proposed Liquidity Staking
Module~\cite{liquidity-staking-module} of Cosmos,
derivative tokens are only fungible when they have been
delegated to the same validator in the same batch.}. We are only concerned with liquid
staking protocols that are fully fungible. At any time, the derivative asset holder
can \emph{redeem} their derivative asset.
% TODO: assets are not directly returned to the user -- LSM shares are. Explain here or later?
During redemption, the contract burns
the holder's derivative assets and returns the respective assets to the holder.
In our treatment, we consider a generic asset that we denominate in \asset
and the respective derivative token, that we denominate in \stasset,
issued by an arbitrary liquid staking protocol.
% TODO: is the loan market infinitely deep?
We assume a perfectly efficient market for \asset and \stasset,
as well as a loan market with rates
$\rasset$, $\betaasset$, $\rstasset$, $\betastasset$.

% TODO: exchange rates between dAsset/Asset 1:1? slashing, rewards
\noindent
\textbf{Exchange rates.} Initially, \asset and \stasset are priced at a 1:1 exchange rate,
as one can be exchanged for the other by redeeming or withdrawing. However, the balance
of the liquid staking protocol in \asset holdings can change with time due to two reasons.
Firstly, it continuously receives rewards for staking the \asset (these rewards are
auto-compounded). Secondly, if a validator it delegates to misbehaves, a portion of its
\asset can get slashed. These events do not change the supply of \stasset in the market.
The deposit and redemption operations must adjust their price.
Let $b_0 \asset$ denote the amount of \asset holdings of the liquid staking
protocol, and $s_0 \stasset$ denote the total market supply of \stasset that the protocol
has issued. When the user deposits $b \asset$, the protocol mints $s = b \frac{s_0}{b_0} \stasset$.
On the other hand, when the user burns $s \asset$, the protocol returns $b = s \frac{b_0}{s_0}$
delegated \asset to the user. These delegated \asset can be unbonded to convert them
to \asset.

Let us consider the price $\alpha$ of \stasset denominated in \asset in the market.
Because the option always exists to mint at a rate of $\frac{s_0}{b_0}$ by
depositing, the price of \stasset denominated in \asset in a perfectly
efficient market is $\frac{b_0}{s_0}$ at maximum. Otherwise, no
rational buyer would use the market. Hence, the market rate is
$\alpha \leq \frac{b_0}{s_0}$.

There are two options to convert $s$ \stasset to \asset: either sell
at the market rate to obtain $b = \alpha s$, or use the redemption mechanism.
Using the redemption mechanism, the \assets become available after time $\delta$.
Initially, using $s$ \stasset, a redemption is made of $b' = s \frac{b_0}{s_0}$
delegated assets. To get $b$ \asset immediately (and avoid having to wait
for the unbonding period), a loan of $b$ \asset is taken~\cite{liquid-staking-report} and
repayed after duration $\delta$. The amount of \asset that needs to be paid back,
including principal and interest, is $((1 + \rasset)^\delta + \betaasset)b$ \asset.
We set this amount to be equal to $b'$, the amount of \assets that will be
unbonded after $\delta$ time. Solving for $b$, we get
$b = s \frac{b_0}{s_0 ((1 + \rasset)^\delta + \betaasset)}$.
Therefore, in an efficient market $\alpha \geq \frac{b_0}{s_0 ((1 + \rasset)^\delta + \betaasset)}$.
We deduce that the bounds for an efficient market of \asset and \stasset are

\[
  \frac{b_0}{s_0 ((1 + \rasset)^\delta + \betaasset)} \leq \alpha \leq \frac{b_0}{s_0}\,.
\]

% ...

% b asset -> s stasset: (buying stasset)
%   Option 1: Trade at the market
%     Market rate: b = (1 / α) s
%
%   Option 2: Deposit
%     Immediately I get s = b \frac{s_0}{b_0}
%     Therefore, I want: 1 / α <= \frac{b_0}{s_0}
%
% Trivial example: s_0 = b_0 = 1, β = 0, r = 0, \delta = 1
% Example: s_0 = b_0 = 1, β = 0, r = 0.01, \delta = 1
%
% s stasset -> b asset: (selling stasset)
%   Option 1: Trade at the market
%     Market rate: b = s (1/α)
%
%   Option 2: Redeem
%     First, withdraw delegated assets b = s \frac{b_0}{s_0}
%     and then I have to wait \delta.
%     To get b asset instantly, I need a loan of b asset for duration \delta.
%     The cost of the loan is ((1 + r)^\delta - 1 + β)b
%     b = s \frac{b_0}{s_0} * (1 - ((1 + r)^\delta - 1 + β))
%     1/α >= \frac{b_0}{s_0} * (1 - ((1 + r)^\delta - 1 + β))

% TODO: mention in a remark (maybe later) that exchange rates between asset/stAsset may not
% be 1:1 because slashing risk and unbonding time must be factored in, and cite
% the economist's paper on liquid staking:
% https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4180341

% TODO: Study a few of the big Liquid Staking protocols (https://defillama.com/protocols/Liquid%20Staking)
% top 13 e.g., Marinade, Algo Liquid, Benqi, Stader, Ankr

\noindent
\textbf{Governance.}
The choice of which validator the liquid staking protocol's assets are delegated to
depends on the particularities of the protocol, but, broadly speaking
is either centralized, or decided through a voting process among
liquid stake holders\footnote{Stride currently have
taken a centralized decision, but plan to make future decisions by voting
among liquid stake holders~\cite{stride-validators}. Lido and Persistence
use a separate governance token~\cite{lido-validators,persistence-validators} for
such decision making in place of stakeholders.}.
In the voting process, anyone can propose for a proportion of the protocols's assets
to be delegated to a validator of their choosing.
Each stakeholder can then vote \emph{yes} or \emph{no}
to a proposal, and decisions are taken by weighted majority.

\begin{itemize}
  \item LSM (tokens)
  \item Quicksilver (refungibilization)
  \item Exempt Delegations
\end{itemize}
